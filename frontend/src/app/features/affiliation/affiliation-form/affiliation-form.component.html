<app-main-layout>
  <div class="fade-in max-w-4xl mx-auto">
    <div class="mb-8">
      <a routerLink="/affiliation" class="text-cnss-primary hover:underline inline-flex items-center mb-4">
        <span class="material-icons mr-1">arrow_back</span>
        {{ i18n.t('forms.backToList') }}
      </a>
      <h1 class="text-3xl font-bold text-cnss-dark">{{ i18n.t('forms.newAffiliation') }}</h1>
      <p class="text-gray-600 mt-2">{{ i18n.t('forms.newAffiliationDesc') }}</p>
    </div>

    <form [formGroup]="affiliationForm" (ngSubmit)="onSubmit()" class="space-y-6">
      
      <!-- Employer Selection -->
      <div class="card">
        <h2 class="text-xl font-bold text-cnss-dark mb-6 flex items-center">
          <span class="material-icons mr-2 text-cnss-primary">business</span>
          {{ i18n.t('forms.employerSelection') }}
        </h2>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            {{ i18n.t('debit.employer') }} <span class="text-red-500">*</span>
          </label>
          <select formControlName="employerId" class="form-field">
            <option value="">{{ i18n.t('forms.selectEmployer') }}</option>
            <option *ngFor="let emp of employers" [value]="emp.id">
              {{ emp.nomCommercial }} ({{ emp.empMat }}-{{ emp.empCle }})
            </option>
          </select>
        </div>
      </div>

      <!-- Employee Personal Information -->
      <div class="card">
        <h2 class="text-xl font-bold text-cnss-dark mb-6 flex items-center">
          <span class="material-icons mr-2 text-cnss-primary">person</span>
          {{ i18n.t('forms.employeeInfo') }}
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.lastName') }} <span class="text-red-500">*</span>
            </label>
            <input type="text" formControlName="lastName" 
                   class="form-field">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.firstName') }} <span class="text-red-500">*</span>
            </label>
            <input type="text" formControlName="firstName" 
                   class="form-field">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.birthDate') }} <span class="text-red-500">*</span>
            </label>
            <input type="date" formControlName="birthDate" 
                   class="form-field">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.birthPlace') }}
            </label>
            <input type="text" formControlName="birthPlace" 
                   class="form-field"
                   placeholder="Ex: Paris">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.nationality') }} <span class="text-red-500">*</span>
            </label>
            <select formControlName="nationality" class="form-field">
              <option value="">{{ i18n.t('forms.selectOption') }}</option>
              <option value="Tunisienne">Tunisienne</option>
              <option value="Française">Française</option>
              <option value="Allemande">Allemande</option>
              <option value="Italienne">Italienne</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.gender') }} <span class="text-red-500">*</span>
            </label>
            <select formControlName="gender" class="form-field">
              <option value="">{{ i18n.t('forms.selectOption') }}</option>
              <option value="M">M</option>
              <option value="F">F</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.passportNumber') }}
            </label>
            <input type="text" formControlName="passportNumber" 
                   class="form-field">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.socialSecurityNumber') }}
            </label>
            <input type="text" formControlName="socialSecurityNumber" 
                   class="form-field">
          </div>
        </div>
      </div>

      <!-- Employment Information -->
      <div class="card">
        <h2 class="text-xl font-bold text-cnss-dark mb-6 flex items-center">
          <span class="material-icons mr-2 text-cnss-primary">work</span>
          {{ i18n.t('forms.employmentInfo') }}
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.startDate') }} <span class="text-red-500">*</span>
            </label>
            <input type="date" formControlName="startDate" 
                   class="form-field">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.endDate') }}
            </label>
            <input type="date" formControlName="endDate" 
                   class="form-field">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.position') }} <span class="text-red-500">*</span>
            </label>
            <input type="text" formControlName="position" 
                   class="form-field">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.contractType') }}
            </label>
            <select formControlName="contractType" class="form-field">
              <option value="CDI">CDI</option>
              <option value="CDD">CDD</option>
            </select>
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.grossSalary') }} <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <input type="number" formControlName="salary" 
                     class="form-field">
              <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500">TND</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Contact Information -->
      <div class="card">
        <h2 class="text-xl font-bold text-cnss-dark mb-6 flex items-center">
          <span class="material-icons mr-2 text-cnss-primary">contact_mail</span>
          {{ i18n.t('forms.coordinates') }}
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.address') }}
            </label>
            <textarea formControlName="address" rows="2" class="form-field"></textarea>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.city') }}
            </label>
            <input type="text" formControlName="city" class="form-field">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.residenceCountry') }}
            </label>
            <input type="text" formControlName="country" class="form-field">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.phone') }}
            </label>
            <input type="tel" formControlName="phone" class="form-field" placeholder="+33 1 23 45 67 89">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              {{ i18n.t('forms.email') }}
            </label>
            <input type="email" formControlName="email" class="form-field" placeholder="exemple@email.com">
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="flex items-center justify-between pt-6 border-t">
        <button type="button" routerLink="/affiliation"
                class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all font-semibold">
          {{ i18n.t('forms.cancel') }}
        </button>
        
        <button type="submit" 
                [disabled]="affiliationForm.invalid || loading"
                class="px-8 py-3 bg-cnss-primary text-white rounded-lg hover:bg-opacity-90 transition-all font-semibold disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
          <span *ngIf="loading" class="spinner-sm mr-2"></span>
          <span class="material-icons mr-2" *ngIf="!loading">save</span>
          {{ i18n.t('forms.registerAffiliation') }}
        </button>
      </div>
    </form>

    <!-- Modal: Attestation Prompt -->
    <div *ngIf="showAttestationPrompt" 
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 text-white">
          <div class="flex items-center justify-center mb-4">
            <span class="material-icons text-6xl">check_circle</span>
          </div>
          <h2 class="text-2xl font-bold text-center">Affiliation Créée avec Succès !</h2>
        </div>
        
        <!-- Body -->
        <div class="p-6">
          <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <span class="text-gray-500">N° Affiliation:</span>
                <p class="font-bold text-cnss-primary">{{ createdAffiliation?.numAffiliation }}</p>
              </div>
              <div>
                <span class="text-gray-500">Nom:</span>
                <p class="font-semibold">{{ createdAffiliation?.fullName }}</p>
              </div>
              <div>
                <span class="text-gray-500">Date Effet:</span>
                <p class="font-semibold">{{ createdAffiliation?.dateEffet }}</p>
              </div>
              <div>
                <span class="text-gray-500">Régime:</span>
                <p class="font-semibold">{{ createdAffiliation?.regime }}</p>
              </div>
            </div>
          </div>
          
          <p class="text-gray-600 text-center mb-6">
            Voulez-vous générer l'attestation d'affiliation officielle pour l'envoyer au citoyen ?
          </p>
          
          <div class="flex flex-col space-y-3">
            <button (click)="generateAttestation()" 
                    class="w-full px-6 py-3 bg-cnss-primary text-white rounded-lg hover:bg-opacity-90 transition-all font-semibold flex items-center justify-center">
              <span class="material-icons mr-2">picture_as_pdf</span>
              Générer et Télécharger l'Attestation PDF
            </button>
            <button (click)="skipAttestation()" 
                    class="w-full px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all font-semibold">
              Passer - Retour à la liste
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</app-main-layout>
