<app-main-layout>
  <div class="fade-in max-w-4xl mx-auto">
    <div class="mb-8">
      <a routerLink="/affiliation" class="text-cnss-primary hover:underline inline-flex items-center mb-4">
        <span class="material-icons mr-1">arrow_back</span>
        Retour à la liste
      </a>
      <h1 class="text-3xl font-bold text-cnss-dark">Nouvelle Affiliation</h1>
      <p class="text-gray-600 mt-2">Enregistrement d'une nouvelle affiliation employé</p>
    </div>

    <form [formGroup]="affiliationForm" (ngSubmit)="onSubmit()" class="space-y-6">
      
      <!-- Employer Selection -->
      <div class="card">
        <h2 class="text-xl font-bold text-cnss-dark mb-6 flex items-center">
          <span class="material-icons mr-2 text-cnss-primary">business</span>
          Sélection de l'Employeur
        </h2>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Employeur <span class="text-red-500">*</span>
          </label>
          <select formControlName="employerId" class="form-field">
            <option value="">Sélectionner un employeur</option>
            <option *ngFor="let emp of employers" [value]="emp.id">
              {{ emp.nomCommercial }} ({{ emp.empMat }}-{{ emp.empCle }})
            </option>
          </select>
          <p *ngIf="employers.length === 0" class="text-sm text-gray-500 mt-1">
            Chargement des employeurs...
          </p>
          <div *ngIf="affiliationForm.get('employerId')?.invalid && affiliationForm.get('employerId')?.touched" 
               class="text-red-600 text-sm mt-1">
            L'employeur est obligatoire
          </div>
        </div>
      </div>

      <!-- Employee Personal Information -->
      <div class="card">
        <h2 class="text-xl font-bold text-cnss-dark mb-6 flex items-center">
          <span class="material-icons mr-2 text-cnss-primary">person</span>
          Informations de l'Employé
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Nom <span class="text-red-500">*</span>
            </label>
            <input type="text" formControlName="lastName" 
                   class="form-field"
                   placeholder="Ex: Dupont">
            <div *ngIf="affiliationForm.get('lastName')?.invalid && affiliationForm.get('lastName')?.touched" 
                 class="text-red-600 text-sm mt-1">
              Le nom est obligatoire
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Prénom <span class="text-red-500">*</span>
            </label>
            <input type="text" formControlName="firstName" 
                   class="form-field"
                   placeholder="Ex: Jean">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Date de Naissance <span class="text-red-500">*</span>
            </label>
            <input type="date" formControlName="birthDate" 
                   class="form-field">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Lieu de Naissance
            </label>
            <input type="text" formControlName="birthPlace" 
                   class="form-field"
                   placeholder="Ex: Paris">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Nationalité <span class="text-red-500">*</span>
            </label>
            <select formControlName="nationality" class="form-field">
              <option value="">Sélectionner</option>
              <option value="Tunisienne">Tunisienne</option>
              <option value="Française">Française</option>
              <option value="Allemande">Allemande</option>
              <option value="Italienne">Italienne</option>
              <option value="Autre">Autre</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Sexe <span class="text-red-500">*</span>
            </label>
            <select formControlName="gender" class="form-field">
              <option value="">Sélectionner</option>
              <option value="M">Masculin</option>
              <option value="F">Féminin</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Numéro Passeport
            </label>
            <input type="text" formControlName="passportNumber" 
                   class="form-field"
                   placeholder="Ex: 12AB34567">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Numéro Sécurité Sociale (pays d'origine)
            </label>
            <input type="text" formControlName="socialSecurityNumber" 
                   class="form-field"
                   placeholder="Ex: 123456789012345">
          </div>
        </div>
      </div>

      <!-- Employment Information -->
      <div class="card">
        <h2 class="text-xl font-bold text-cnss-dark mb-6 flex items-center">
          <span class="material-icons mr-2 text-cnss-primary">work</span>
          Informations d'Emploi
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Date de Début <span class="text-red-500">*</span>
            </label>
            <input type="date" formControlName="startDate" 
                   class="form-field">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Date de Fin (si CDD)
            </label>
            <input type="date" formControlName="endDate" 
                   class="form-field">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Poste <span class="text-red-500">*</span>
            </label>
            <input type="text" formControlName="position" 
                   class="form-field"
                   placeholder="Ex: Ingénieur Commercial">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Type de Contrat
            </label>
            <select formControlName="contractType" class="form-field">
              <option value="CDI">CDI</option>
              <option value="CDD">CDD</option>
              <option value="Stage">Stage</option>
              <option value="Autre">Autre</option>
            </select>
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Salaire Mensuel Brut <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <input type="number" formControlName="salary" 
                     class="form-field"
                     placeholder="Ex: 2500">
              <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500">TND</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Contact Information -->
      <div class="card">
        <h2 class="text-xl font-bold text-cnss-dark mb-6 flex items-center">
          <span class="material-icons mr-2 text-cnss-primary">contact_mail</span>
          Coordonnées
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Adresse
            </label>
            <textarea formControlName="address" rows="2"
                      class="form-field"
                      placeholder="Adresse complète"></textarea>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Ville
            </label>
            <input type="text" formControlName="city" 
                   class="form-field"
                   placeholder="Ex: Paris">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Pays de Résidence
            </label>
            <input type="text" formControlName="country" 
                   class="form-field"
                   placeholder="Ex: France">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Téléphone
            </label>
            <input type="tel" formControlName="phone" 
                   class="form-field"
                   placeholder="+33 1 23 45 67 89">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Email
            </label>
            <input type="email" formControlName="email" 
                   class="form-field"
                   placeholder="exemple@email.com">
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="flex items-center justify-between pt-6 border-t">
        <button type="button" 
                routerLink="/affiliation"
                class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all font-semibold">
          Annuler
        </button>
        
        <div class="flex items-center gap-4">
          <p *ngIf="affiliationForm.invalid" class="text-red-500 text-sm">
            Veuillez remplir tous les champs obligatoires (*)
          </p>
          <button type="submit" 
                  [disabled]="affiliationForm.invalid || loading"
                  class="px-8 py-3 bg-cnss-primary text-white rounded-lg hover:bg-opacity-90 transition-all font-semibold disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
            <span *ngIf="loading" class="spinner-sm mr-2"></span>
            <span class="material-icons mr-2" *ngIf="!loading">save</span>
            {{ loading ? 'Enregistrement...' : 'Enregistrer l\'Affiliation' }}
          </button>
        </div>
      </div>
    </form>

    <!-- Modal: Attestation Prompt -->
    <div *ngIf="showAttestationPrompt" 
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 text-white">
          <div class="flex items-center justify-center mb-4">
            <span class="material-icons text-6xl">check_circle</span>
          </div>
          <h2 class="text-2xl font-bold text-center">Affiliation Créée avec Succès !</h2>
        </div>
        
        <!-- Body -->
        <div class="p-6">
          <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <span class="text-gray-500">N° Affiliation:</span>
                <p class="font-bold text-cnss-primary">{{ createdAffiliation?.numAffiliation }}</p>
              </div>
              <div>
                <span class="text-gray-500">Nom:</span>
                <p class="font-semibold">{{ createdAffiliation?.fullName }}</p>
              </div>
              <div>
                <span class="text-gray-500">Date Effet:</span>
                <p class="font-semibold">{{ createdAffiliation?.dateEffet }}</p>
              </div>
              <div>
                <span class="text-gray-500">Régime:</span>
                <p class="font-semibold">{{ createdAffiliation?.regime }}</p>
              </div>
            </div>
          </div>
          
          <p class="text-gray-600 text-center mb-6">
            Voulez-vous générer l'attestation d'affiliation officielle pour l'envoyer au citoyen ?
          </p>
          
          <div class="flex flex-col space-y-3">
            <button (click)="generateAttestation()" 
                    class="w-full px-6 py-3 bg-cnss-primary text-white rounded-lg hover:bg-opacity-90 transition-all font-semibold flex items-center justify-center">
              <span class="material-icons mr-2">picture_as_pdf</span>
              Générer et Télécharger l'Attestation PDF
            </button>
            <button (click)="skipAttestation()" 
                    class="w-full px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all font-semibold">
              Passer - Retour à la liste
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</app-main-layout>
