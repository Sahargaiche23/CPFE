<!-- Mode connecté: avec layout -->
<ng-container *ngIf="!isPublicMode">
  <app-main-layout>
    <ng-container *ngTemplateOutlet="formContent"></ng-container>
  </app-main-layout>
</ng-container>

<!-- Mode public: sans layout -->
<div *ngIf="isPublicMode" class="min-h-screen bg-gradient-to-br from-cnss-primary via-cnss-secondary to-cnss-accent py-8 px-4">
  <div class="max-w-5xl mx-auto">
    <ng-container *ngTemplateOutlet="formContent"></ng-container>
  </div>
</div>

<!-- Template du formulaire -->
<ng-template #formContent>
  <div class="fade-in max-w-5xl mx-auto" [class.bg-white]="isPublicMode" [class.rounded-2xl]="isPublicMode" [class.shadow-2xl]="isPublicMode" [class.p-8]="isPublicMode">
    
    <!-- Message de succès (mode public) -->
    <div *ngIf="successMessage" class="bg-green-50 border-l-4 border-green-500 text-green-700 p-6 mb-6 rounded">
      <div class="flex items-center mb-4">
        <span class="material-icons mr-2 text-3xl">check_circle</span>
        <div>
          <div class="text-lg font-bold">{{ successMessage }}</div>
          <div *ngIf="createdMatricule" class="mt-2"><strong>Matricule:</strong> {{ createdMatricule }}</div>
          <div class="mt-1 text-sm">Vos identifiants: <strong>Login = {{ createdEmail }}</strong> / <strong>Mot de passe = {{ createdMatricule }}cnss</strong></div>
        </div>
      </div>
      <div class="text-center mt-4">
        <button type="button" (click)="goToLogin()" class="bg-cnss-primary text-white px-6 py-3 rounded-lg font-semibold hover:bg-opacity-90 transition-all">
          <span class="material-icons mr-2 align-middle">login</span>
          Aller à la connexion
        </button>
      </div>
    </div>
    
    <div class="mb-8" *ngIf="!successMessage">
      <a *ngIf="!isPublicMode" routerLink="/cooperant" class="text-cnss-primary hover:underline inline-flex items-center mb-4">
        <span class="material-icons mr-1">arrow_back</span>
        Retour
      </a>
      <a *ngIf="isPublicMode" routerLink="/auth/login" class="text-cnss-primary hover:underline inline-flex items-center mb-4">
        <span class="material-icons mr-1">arrow_back</span>
        Retour à la connexion
      </a>
      <h1 class="text-3xl font-bold text-cnss-dark">{{ isPublicMode ? 'Dépôt de dossier Coopérant' : (isEditMode ? 'Modifier Coopérant' : 'Nouveau Coopérant') }}</h1>
      <p class="text-gray-600 mt-2">{{ isPublicMode ? 'Remplissez le formulaire et joignez vos documents. Un compte sera créé automatiquement.' : 'Saisie personne (FR/AR) + documents' }}</p>
    </div>

    <form *ngIf="!successMessage" [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-6">

      <div class="card">
        <h2 class="text-xl font-bold text-cnss-dark mb-6 flex items-center">
          <span class="material-icons mr-2 text-cnss-primary">category</span>
          Type de Régime
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <label class="relative cursor-pointer">
            <input type="radio" formControlName="codeRegime" value="500" class="sr-only peer">
            <div class="p-5 border-2 border-gray-300 rounded-lg peer-checked:border-cnss-primary peer-checked:bg-blue-50 transition-all">
              <div class="flex items-center justify-between mb-2">
                <span class="text-lg font-bold">500</span>
                <span class="material-icons text-blue-600">person</span>
              </div>
              <p class="text-sm text-gray-600">Coopérant Général</p>
            </div>
          </label>
          <label class="relative cursor-pointer">
            <input type="radio" formControlName="codeRegime" value="510" class="sr-only peer">
            <div class="p-5 border-2 border-gray-300 rounded-lg peer-checked:border-cnss-primary peer-checked:bg-green-50 transition-all">
              <div class="flex items-center justify-between mb-2">
                <span class="text-lg font-bold">510</span>
                <span class="material-icons text-green-600">agriculture</span>
              </div>
              <p class="text-sm text-gray-600">Coopérant Agricole Amélioré</p>
            </div>
          </label>
          <label class="relative cursor-pointer">
            <input type="radio" formControlName="codeRegime" value="515" class="sr-only peer">
            <div class="p-5 border-2 border-gray-300 rounded-lg peer-checked:border-cnss-primary peer-checked:bg-yellow-50 transition-all">
              <div class="flex items-center justify-between mb-2">
                <span class="text-lg font-bold">515</span>
                <span class="material-icons text-yellow-700">grass</span>
              </div>
              <p class="text-sm text-gray-600">Régime Agricole</p>
            </div>
          </label>
        </div>
      </div>

      <div class="card">
        <h2 class="text-xl font-bold text-cnss-dark mb-6 flex items-center">
          <span class="material-icons mr-2 text-cnss-primary">badge</span>
          Identité (FR)
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Nom (FR) *</label>
            <input type="text" formControlName="nomFr" class="form-field">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Prénom (FR) *</label>
            <input type="text" formControlName="prenomFr" class="form-field">
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Adresse (FR) *</label>
            <textarea rows="3" formControlName="adresseFr" class="form-field"></textarea>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Code postal</label>
            <input type="text" formControlName="codePostal" class="form-field">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Localité (FR)</label>
            <input type="text" formControlName="localiteFr" class="form-field">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Date de naissance</label>
            <input type="date" formControlName="dateNaissance" class="form-field">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Lieu de naissance (FR)</label>
            <input type="text" formControlName="lieuNaissanceFr" class="form-field">
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="text-xl font-bold text-cnss-dark mb-6 flex items-center">
          <span class="material-icons mr-2 text-cnss-primary">translate</span>
          Identité (AR)
          <span class="text-sm text-gray-500 mr-2">(Cliquez sur ⌨️ pour le clavier arabe)</span>
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">اللقب</label>
            <div class="relative">
              <input type="text" formControlName="nomAr" class="form-field pr-10" dir="rtl">
              <button type="button" (click)="toggleArabicKeyboard('nomAr')" 
                      class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-cnss-primary"
                      [class.text-cnss-primary]="activeArabicField === 'nomAr'">
                ⌨️
              </button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">الاسم</label>
            <div class="relative">
              <input type="text" formControlName="prenomAr" class="form-field pr-10" dir="rtl">
              <button type="button" (click)="toggleArabicKeyboard('prenomAr')" 
                      class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-cnss-primary"
                      [class.text-cnss-primary]="activeArabicField === 'prenomAr'">
                ⌨️
              </button>
            </div>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-2">العنوان</label>
            <div class="relative">
              <textarea rows="3" formControlName="adresseAr" class="form-field pr-10" dir="rtl"></textarea>
              <button type="button" (click)="toggleArabicKeyboard('adresseAr')" 
                      class="absolute left-2 top-4 text-gray-500 hover:text-cnss-primary"
                      [class.text-cnss-primary]="activeArabicField === 'adresseAr'">
                ⌨️
              </button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">المحلية</label>
            <div class="relative">
              <input type="text" formControlName="localiteAr" class="form-field pr-10" dir="rtl">
              <button type="button" (click)="toggleArabicKeyboard('localiteAr')" 
                      class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-cnss-primary"
                      [class.text-cnss-primary]="activeArabicField === 'localiteAr'">
                ⌨️
              </button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">مكان الولادة</label>
            <div class="relative">
              <input type="text" formControlName="lieuNaissanceAr" class="form-field pr-10" dir="rtl">
              <button type="button" (click)="toggleArabicKeyboard('lieuNaissanceAr')" 
                      class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-cnss-primary"
                      [class.text-cnss-primary]="activeArabicField === 'lieuNaissanceAr'">
                ⌨️
              </button>
            </div>
          </div>
        </div>
        
        <!-- Clavier arabe virtuel -->
        <div class="mt-4" *ngIf="activeArabicField">
          <app-arabic-keyboard #arabicKeyboard
            (keyPress)="onArabicKeyPress($event)"
            (backspace)="onArabicBackspace()"
            (closed)="onArabicKeyboardClosed()">
          </app-arabic-keyboard>
        </div>
      </div>

      <div class="card">
        <h2 class="text-xl font-bold text-cnss-dark mb-6 flex items-center">
          <span class="material-icons mr-2 text-cnss-primary">contact_mail</span>
          Contact & Pièce
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Téléphone</label>
            <input type="text" formControlName="telephone" class="form-field">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Fax</label>
            <input type="text" formControlName="fax" class="form-field">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
            <input type="email" formControlName="email" class="form-field">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Nationalité</label>
            <input type="text" formControlName="nationalite" class="form-field">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Type pièce *</label>
            <select formControlName="typePieceIdentite" class="form-field">
              <option value="CIN">CIN</option>
              <option value="PASSEPORT">PASSEPORT</option>
              <option value="CARTE_SEJOUR">CARTE_SEJOUR</option>
              <option value="AUTRE">AUTRE</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">N° pièce *</label>
            <input type="text" formControlName="numPieceIdentite" class="form-field">
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Dossier (PDF/Word/Image)</label>
            <input type="file" (change)="onFileChange($event, 'dossier')" class="form-field" accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,image/*">
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Pièce identité (Scan/Image/PDF)</label>
            <input type="file" (change)="onFileChange($event, 'identite')" class="form-field" accept="application/pdf,image/*">
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between pt-6 border-t" *ngIf="!successMessage">
        <button type="button" [routerLink]="isPublicMode ? '/auth/login' : '/cooperant'" class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all font-semibold">
          {{ isPublicMode ? 'Retour' : 'Annuler' }}
        </button>
        <button type="submit" [disabled]="form.invalid || loading" class="px-8 py-3 bg-cnss-primary text-white rounded-lg hover:bg-opacity-90 transition-all font-semibold disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
          <span *ngIf="loading" class="spinner-sm mr-2"></span>
          <span class="material-icons mr-2" *ngIf="!loading">save</span>
          {{ isPublicMode ? 'Déposer le dossier' : 'Enregistrer' }}
        </button>
      </div>

    </form>
  </div>
</ng-template>
