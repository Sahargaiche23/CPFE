<app-main-layout>
  <div class="fade-in">
    <div class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-3xl font-bold text-cnss-dark">Coopérants</h1>
        <p class="text-gray-600 mt-2">Gestion des personnes coopérantes (FR/AR) + validation agent</p>
      </div>
      <div class="flex gap-3">
        <a routerLink="/cooperant/validation" class="px-4 py-2 bg-cnss-secondary text-white rounded-lg hover:bg-opacity-90 transition-all flex items-center">
          <span class="material-icons mr-2">verified</span>
          Validation
        </a>
        <a routerLink="/cooperant/new" class="btn-primary">
          <span class="material-icons mr-2">add</span>
          Nouveau coopérant
        </a>
      </div>
    </div>

    <div class="card mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Recherche</label>
          <input type="text" [(ngModel)]="searchTerm" placeholder="Nom / matricule / pièce..."
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cnss-primary focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Régime</label>
          <select [(ngModel)]="selectedRegime" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cnss-primary focus:border-transparent">
            <option value="">Tous</option>
            <option value="500">500 - Coopérant Général</option>
            <option value="510">510 - Coopérant Agricole Amélioré</option>
            <option value="515">515 - Régime Agricole</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Validation</label>
          <select [(ngModel)]="selectedValidation" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cnss-primary focus:border-transparent">
            <option value="">Tous</option>
            <option value="EN_ATTENTE">EN_ATTENTE</option>
            <option value="VALIDE">VALIDE</option>
            <option value="REJETE">REJETE</option>
          </select>
        </div>
        <div class="flex items-end">
          <button (click)="applyFilters()" class="w-full px-6 py-2 bg-cnss-secondary text-white rounded-lg hover:bg-opacity-90 transition-all">
            <span class="material-icons text-sm mr-1">search</span>
            Filtrer
          </button>
        </div>
      </div>
    </div>

    <div class="card">
      <div *ngIf="loading" class="flex justify-center py-12">
        <div class="spinner"></div>
      </div>

      <div *ngIf="!loading" class="overflow-x-auto">
        <table class="data-table">
          <thead>
            <tr>
              <th>Matricule</th>
              <th>Nom</th>
              <th>Régime</th>
              <th>Pièce</th>
              <th>Validation</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of filtered" class="hover:bg-gray-50">
              <td class="font-mono text-sm">{{ c.matriculeComplet || (c.matricule + '-' + c.cle) }}</td>
              <td>
                <div class="font-semibold text-gray-900">{{ c.nomCompletFr || (c.prenomFr + ' ' + c.nomFr) }}</div>
                <div class="text-sm text-gray-500" *ngIf="c.nomCompletAr">{{ c.nomCompletAr }}</div>
              </td>
              <td>
                <span class="badge" [ngClass]="{
                  'bg-blue-100 text-blue-800': c.codeRegime === '500',
                  'bg-green-100 text-green-800': c.codeRegime === '510',
                  'bg-yellow-100 text-yellow-800': c.codeRegime === '515'
                }">
                  {{ c.codeRegime }}
                </span>
              </td>
              <td>{{ c.typePieceIdentite }} {{ c.numPieceIdentite }}</td>
              <td>
                <span class="badge" [ngClass]="{
                  'bg-yellow-100 text-yellow-800': c.statutValidation === 'EN_ATTENTE',
                  'bg-green-100 text-green-800': c.statutValidation === 'VALIDE',
                  'bg-red-100 text-red-800': c.statutValidation === 'REJETE'
                }">
                  {{ c.statutValidation || 'EN_ATTENTE' }}
                </span>
              </td>
              <td>
                <div class="flex items-center space-x-2">
                  <a [routerLink]="['/cooperant', c.id]" class="text-blue-600 hover:text-blue-800" title="Détails">
                    <span class="material-icons text-xl">visibility</span>
                  </a>
                  <a [routerLink]="['/cooperant/edit', c.id]" class="text-green-600 hover:text-green-800" title="Modifier">
                    <span class="material-icons text-xl">edit</span>
                  </a>
                  <a *ngIf="c.statutValidation === 'VALIDE'" [routerLink]="['/affiliation/complete', c.id]" 
                     class="text-purple-600 hover:text-purple-800" title="Compléter l'affiliation">
                    <span class="material-icons text-xl">assignment</span>
                  </a>
                  <button (click)="confirmDelete(c)" class="text-red-600 hover:text-red-800" title="Supprimer">
                    <span class="material-icons text-xl">delete</span>
                  </button>
                </div>
              </td>
            </tr>

            <tr *ngIf="filtered.length === 0">
              <td colspan="6" class="text-center py-12 text-gray-500">
                <span class="material-icons text-6xl mb-4 block text-gray-300">person</span>
                <p class="text-lg font-semibold">Aucun coopérant trouvé</p>
                <button *ngIf="cooperants.length > 0" (click)="resetFilters()" class="btn-outline mt-4 inline-flex items-center">
                  <span class="material-icons mr-2">refresh</span>
                  Réinitialiser
                </button>
                <a *ngIf="cooperants.length === 0" routerLink="/cooperant/new" class="btn-primary mt-4 inline-flex items-center">
                  <span class="material-icons mr-2">add</span>
                  Créer un coopérant
                </a>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modale de confirmation de suppression -->
    <div *ngIf="deleteId" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg shadow-2xl w-full max-w-md p-6">
        <div class="flex items-center mb-4">
          <span class="material-icons text-red-600 text-3xl mr-3">warning</span>
          <h2 class="text-xl font-bold text-gray-800">Confirmer la suppression</h2>
        </div>
        <p class="text-gray-600 mb-6">
          Êtes-vous sûr de vouloir supprimer le coopérant <strong>{{ deleteName }}</strong> ?
          Cette action est irréversible.
        </p>
        <div class="flex justify-end gap-3">
          <button (click)="cancelDelete()" class="px-5 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
            Annuler
          </button>
          <button (click)="deleteCooperant()" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
            Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>
</app-main-layout>
