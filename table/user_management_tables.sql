-- ========================================
-- Tables pour la gestion des utilisateurs et logs
-- CNSS - Coopération Technique
-- ========================================

-- Table des gouvernorats (24 gouvernorats de Tunisie)
CREATE TABLE COPT.GOVERNORATE (
    GOV_CODE NUMBER(2) PRIMARY KEY,
    GOV_NAME VARCHAR2(50) NOT NULL,
    GOV_NAME_AR VARCHAR2(50),
    REGION VARCHAR2(20)
);

-- Insertion des 24 gouvernorats
INSERT INTO COPT.GOVERNORATE VALUES (11, 'Tunis', 'تونس', 'Grand Tunis');
INSERT INTO COPT.GOVERNORATE VALUES (12, 'Ariana', 'أريانة', 'Grand Tunis');
INSERT INTO COPT.GOVERNORATE VALUES (13, 'Ben Arous', 'بن عروس', 'Grand Tunis');
INSERT INTO COPT.GOVERNORATE VALUES (14, 'Manouba', 'منوبة', 'Grand Tunis');
INSERT INTO COPT.GOVERNORATE VALUES (21, 'Nabeul', 'نابل', 'Nord-Est');
INSERT INTO COPT.GOVERNORATE VALUES (22, 'Zaghouan', 'زغوان', 'Nord-Est');
INSERT INTO COPT.GOVERNORATE VALUES (23, 'Bizerte', 'بنزرت', 'Nord');
INSERT INTO COPT.GOVERNORATE VALUES (31, 'Béja', 'باجة', 'Nord-Ouest');
INSERT INTO COPT.GOVERNORATE VALUES (32, 'Jendouba', 'جندوبة', 'Nord-Ouest');
INSERT INTO COPT.GOVERNORATE VALUES (33, 'Le Kef', 'الكاف', 'Nord-Ouest');
INSERT INTO COPT.GOVERNORATE VALUES (34, 'Siliana', 'سليانة', 'Nord-Ouest');
INSERT INTO COPT.GOVERNORATE VALUES (41, 'Sousse', 'سوسة', 'Centre-Est');
INSERT INTO COPT.GOVERNORATE VALUES (42, 'Monastir', 'المنستير', 'Centre-Est');
INSERT INTO COPT.GOVERNORATE VALUES (43, 'Mahdia', 'المهدية', 'Centre-Est');
INSERT INTO COPT.GOVERNORATE VALUES (51, 'Kairouan', 'القيروان', 'Centre');
INSERT INTO COPT.GOVERNORATE VALUES (52, 'Kasserine', 'القصرين', 'Centre-Ouest');
INSERT INTO COPT.GOVERNORATE VALUES (53, 'Sidi Bouzid', 'سيدي بوزيد', 'Centre-Ouest');
INSERT INTO COPT.GOVERNORATE VALUES (61, 'Sfax', 'صفاقس', 'Sud-Est');
INSERT INTO COPT.GOVERNORATE VALUES (71, 'Gabès', 'قابس', 'Sud-Est');
INSERT INTO COPT.GOVERNORATE VALUES (72, 'Médenine', 'مدنين', 'Sud-Est');
INSERT INTO COPT.GOVERNORATE VALUES (73, 'Tataouine', 'تطاوين', 'Sud-Est');
INSERT INTO COPT.GOVERNORATE VALUES (81, 'Gafsa', 'قفصة', 'Sud-Ouest');
INSERT INTO COPT.GOVERNORATE VALUES (82, 'Tozeur', 'توزر', 'Sud-Ouest');
INSERT INTO COPT.GOVERNORATE VALUES (83, 'Kébili', 'قبلي', 'Sud-Ouest');

-- Table des bureaux CNSS
CREATE TABLE COPT.BUREAU_CNSS (
    BUR_CODE NUMBER(3) PRIMARY KEY,
    BUR_NAME VARCHAR2(100) NOT NULL,
    GOV_CODE NUMBER(2) REFERENCES COPT.GOVERNORATE(GOV_CODE),
    ADDRESS VARCHAR2(255),
    PHONE VARCHAR2(20),
    ACTIVE NUMBER(1) DEFAULT 1
);

-- Table des logs d'audit
CREATE TABLE COPT.AUDIT_LOG (
    LOG_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USER_ID NUMBER NOT NULL,
    USERNAME VARCHAR2(50) NOT NULL,
    ACTION VARCHAR2(50) NOT NULL,
    DESCRIPTION VARCHAR2(500),
    IP_ADDRESS VARCHAR2(45),
    USER_AGENT VARCHAR2(500),
    LOCATION VARCHAR2(100),
    BUR_CODE NUMBER(3),
    SUCCESS NUMBER(1) DEFAULT 1,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Index pour améliorer les performances
CREATE INDEX IDX_AUDIT_USER ON COPT.AUDIT_LOG(USER_ID);
CREATE INDEX IDX_AUDIT_DATE ON COPT.AUDIT_LOG(CREATED_AT);
CREATE INDEX IDX_AUDIT_ACTION ON COPT.AUDIT_LOG(ACTION);

-- Modifier la table APP_USER pour ajouter les nouvelles colonnes
ALTER TABLE COPT.APP_USER ADD (
    EMAIL VARCHAR2(100),
    FIRST_NAME VARCHAR2(50),
    LAST_NAME VARCHAR2(50),
    GOV_CODE NUMBER(2),
    ACTIVE NUMBER(1) DEFAULT 1,
    LAST_LOGIN TIMESTAMP,
    LAST_IP VARCHAR2(45),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP,
    CREATED_BY NUMBER
);

-- Commentaires
COMMENT ON TABLE COPT.AUDIT_LOG IS 'Journal d''audit des actions utilisateurs';
COMMENT ON TABLE COPT.GOVERNORATE IS 'Liste des 24 gouvernorats de Tunisie';
COMMENT ON TABLE COPT.BUREAU_CNSS IS 'Bureaux CNSS par gouvernorat';

COMMIT;
